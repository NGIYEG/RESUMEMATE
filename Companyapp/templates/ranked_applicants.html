{% extends 'company_base.html' %}

{% block sidebar %}{% endblock %}

{% block main_class %}flex-1 p-8 overflow-y-auto w-full{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-rose-50 py-10 px-4">
  <div class="max-w-7xl mx-auto">
    
    <div class="bg-white/40 backdrop-blur-2xl rounded-3xl shadow-2xl p-6 mb-8 border-l-8 border-orange-500 border border-white/60 flex flex-col md:flex-row justify-between items-start gap-4">
      <div>
          <h1 class="text-4xl font-extrabold bg-gradient-to-r from-amber-900 via-orange-800 to-rose-800 bg-clip-text text-transparent">
            {{ job.post.title }}
          </h1>
          <p class="text-amber-800 font-medium mt-1">{{ job.department.name }} • Deadline: {{ job.deadline|date:"M d, Y" }}</p>
          
          <div class="mt-4 flex flex-wrap gap-3 text-sm">
            <span class="bg-gradient-to-r from-amber-100 to-orange-100 text-amber-900 px-4 py-2 rounded-full border-2 border-amber-300 font-bold shadow-md">
              Required Exp: {{ job.min_experience_years }}+ Years
            </span>
            
            <span class="bg-gradient-to-r from-amber-100 to-orange-100 text-amber-900 px-4 py-2 rounded-full border-2 border-amber-300 font-bold shadow-md">
              {% with first_course=job.selected_courses.all.0 %}
                  {% if first_course %}
                      {% if "bachelor" in job.required_education|lower or "degree" in job.required_education|lower %}
                          BSc. {{ first_course.name }}
                      {% elif "master" in job.required_education|lower %}
                          MSc. {{ first_course.name }}
                      {% elif "diploma" in job.required_education|lower %}
                          Dip. {{ first_course.name }}
                      {% else %}
                          {{ job.required_education }} in {{ first_course.name }}
                      {% endif %}
                      
                      {% if job.selected_courses.count > 1 %}
                        <span class="text-xs opacity-70">(or related)</span>
                      {% endif %}
                  {% else %}
                      Education: {{ job.required_education }}
                  {% endif %}
              {% endwith %}
            </span>
          </div>
      </div>

      <button id="contactBtn" onclick="openEmailModal()" disabled 
              class="bg-gradient-to-r from-amber-800 to-orange-800 text-white px-6 py-3 rounded-2xl font-bold transition flex items-center gap-2 shadow-xl shrink-0 opacity-50 cursor-not-allowed hover:from-amber-900 hover:to-orange-900">
          <i class="fa-regular fa-paper-plane"></i> Contact Selected
      </button>
    </div>

    <div class="bg-white/40 backdrop-blur-2xl rounded-3xl shadow-2xl overflow-hidden border border-white/60">
      <div class="px-6 py-5 border-b border-amber-200/50 flex justify-between items-center bg-gradient-to-r from-amber-50/50 to-orange-50/50">
        <h2 class="font-bold text-amber-900 text-2xl">Ranked Applicants ({{ candidates|length }})</h2>
        <span class="text-xs text-amber-700 font-medium bg-amber-100 px-3 py-1 rounded-full">Sorted by AI Match Score</span>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead>
            <tr class="text-amber-800 text-sm bg-gradient-to-r from-amber-100/50 to-orange-100/50 uppercase tracking-wider">
              <th class="px-6 py-4 w-10">
                  <input type="checkbox" id="selectAll" onclick="toggleAll(this)" class="rounded border-amber-300 text-orange-600 focus:ring-orange-500 w-5 h-5 cursor-pointer">
              </th>
              <th class="px-6 py-4 font-bold">Rank</th>
              <th class="px-6 py-4 font-bold">Candidate</th>
              <th class="px-6 py-4 font-bold">Match Score</th>
              <th class="px-6 py-4 font-bold">Key Insights</th>
              <th class="px-6 py-4 font-bold">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-amber-200/50">
            {% for candidate in candidates %}
            <tr class="hover:bg-amber-50/50 transition duration-150">
              
              <td class="px-6 py-4">
                  <input type="checkbox" name="applicant_check" value="{{ candidate.applicant.applicant_id }}" onclick="updateButtonState()" class="applicant-checkbox rounded border-amber-300 text-orange-600 focus:ring-orange-500 w-5 h-5 cursor-pointer">
              </td>

              <td class="px-6 py-4">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl font-extrabold shadow-lg
                  {% if forloop.counter == 1 %}bg-gradient-to-br from-yellow-400 to-amber-500 text-white border-2 border-yellow-300
                  {% elif forloop.counter == 2 %}bg-gradient-to-br from-gray-300 to-slate-400 text-white border-2 border-gray-200
                  {% elif forloop.counter == 3 %}bg-gradient-to-br from-orange-400 to-amber-600 text-white border-2 border-orange-300
                  {% else %}text-amber-700 bg-amber-100 border-2 border-amber-200{% endif %}">
                  {{ forloop.counter }}
                </div>
              </td>

              <td class="px-6 py-4">
                <div>
                  <p class="font-bold text-amber-900 text-lg">
                    {{ candidate.applicant.first_name }} {{ candidate.applicant.last_name }}
                  </p>
                  <p class="text-xs text-amber-700 font-medium">
                    {{ candidate.applicant.email }}
                  </p>
                  <p class="text-xs text-amber-600">
                    Applied: {{ candidate.application_date|date:"M d, Y" }}
                  </p>
                </div>
              </td>

              <td class="px-6 py-4 w-48">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-2xl font-extrabold 
                    {% if candidate.score >= 80 %}text-emerald-700
                    {% elif candidate.score >= 50 %}text-amber-700
                    {% else %}text-rose-700{% endif %}">
                    {{ candidate.score }}%
                  </span>
                  <div class="w-full bg-amber-200 rounded-full h-3 shadow-inner">
                    <div class="h-3 rounded-full shadow-lg
                      {% if candidate.score >= 80 %}bg-gradient-to-r from-emerald-500 to-teal-500
                      {% elif candidate.score >= 50 %}bg-gradient-to-r from-amber-500 to-orange-500
                      {% else %}bg-gradient-to-r from-rose-500 to-pink-500{% endif %}" 
                      style="width: {{ candidate.score }}%;">
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-2 text-xs font-bold">
                  <span class="text-purple-700 bg-purple-100 px-2 py-1 rounded-lg" title="Skills Score">S: {{ candidate.skills_score|default:0 }}%</span>
                  <span class="text-indigo-700 bg-indigo-100 px-2 py-1 rounded-lg" title="Experience Score">E: {{ candidate.experience_score|default:0 }}%</span>
                  <span class="text-emerald-700 bg-emerald-100 px-2 py-1 rounded-lg" title="Education Score">Ed: {{ candidate.education_score|default:0 }}%</span>
                </div>
              </td>

              <td class="px-6 py-4 text-sm text-amber-900 max-w-xs">
                {% if candidate.matched_skills %}
                <div class="mb-2">
                  <span class="font-bold text-xs text-emerald-800 uppercase">✓ Matched:</span>
                  <div class="flex flex-wrap gap-1 mt-1">
                    {% for skill in candidate.matched_skills|slice:":3" %}
                      <span class="px-2 py-1 bg-gradient-to-r from-emerald-100 to-teal-100 text-emerald-800 rounded-lg text-xs border border-emerald-300 font-medium">{{ skill }}</span>
                    {% endfor %}
                    {% if candidate.matched_skills|length > 3 %}
                      <span class="text-xs text-amber-600 font-bold">+{{ candidate.matched_skills|length|add:"-3" }}</span>
                    {% endif %}
                  </div>
                </div>
                {% endif %}

                {% if candidate.missing_skills %}
                <div class="mb-2">
                  <span class="font-bold text-xs text-rose-800 uppercase">✗ Missing:</span>
                  <div class="flex flex-wrap gap-1 mt-1">
                    {% for skill in candidate.missing_skills|slice:":2" %}
                      <span class="px-2 py-1 bg-gradient-to-r from-rose-100 to-pink-100 text-rose-800 rounded-lg text-xs border border-rose-300 font-medium">{{ skill }}</span>
                    {% endfor %}
                    {% if candidate.missing_skills|length > 2 %}
                      <span class="text-xs text-amber-600 font-bold">+{{ candidate.missing_skills|length|add:"-2" }}</span>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                
                <div>
                  <span class="font-bold text-xs text-amber-700 uppercase">Latest Role:</span>
                  <p class="truncate text-xs text-amber-900">{{ candidate.resume_experience.0|default:"-- None --" }}</p>
                </div>
              </td>

              <td class="px-6 py-4">
                <div class="flex flex-col gap-2">
                  <a href="{% url 'career:public_profile' candidate.applicant.pk %}" 
                 class="text-orange-700 hover:text-orange-900 font-bold text-sm hover:underline flex items-center gap-1">
                    Review <i class="fa-solid fa-arrow-right"></i>
                  </a>
                </div>
              </td>

            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-16">
                <div class="flex flex-col items-center">
                  <div class="w-20 h-20 bg-gradient-to-br from-amber-200 to-orange-200 rounded-2xl flex items-center justify-center mb-4">
                    <i class="fa-solid fa-users text-4xl text-amber-700"></i>
                  </div>
                  <p class="text-lg font-bold text-amber-900">No applicants found.</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="fixed inset-0 bg-black/60 z-100 hidden flex items-center justify-center backdrop-blur-md">
    <div class="bg-white/40 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all scale-95 opacity-0 border border-white/60" id="modalContent">
        <div class="bg-gradient-to-r from-amber-700 to-orange-700 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white font-bold text-xl"><i class="fa-regular fa-envelope mr-2"></i> Send Bulk Email</h3>
            <button onclick="closeEmailModal()" class="text-white/80 hover:text-white transition">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>
        <form action="{% url 'send_bulk_emails' %}" method="POST" class="p-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="job_id" value="{{ job.id }}">
            <input type="hidden" name="applicant_ids" id="hiddenApplicantIds">
            <div>
                <label class="block text-sm font-bold text-amber-900 mb-1">To:</label>
                <div class="text-sm text-amber-800 bg-amber-50 p-3 rounded-xl border border-amber-200 font-medium" id="recipientCountDisplay">
                    Select applicants to see count.
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-amber-900 mb-1">Subject</label>
                <input type="text" name="email_subject" required class="w-full px-4 py-3 rounded-xl border-2 border-amber-200 bg-white/70 backdrop-blur-sm text-amber-900 font-medium focus:ring-2 focus:ring-orange-400 focus:border-orange-400" placeholder="e.g. Invitation to Interview">
            </div>
            <div>
                <label class="block text-sm font-bold text-amber-900 mb-1">Message</label>
                <textarea name="email_message" rows="6" required class="w-full px-4 py-3 rounded-xl border-2 border-amber-200 bg-white/70 backdrop-blur-sm text-amber-900 font-medium focus:ring-2 focus:ring-orange-400 focus:border-orange-400" placeholder="Write your message here..."></textarea>
                <p class="text-xs text-amber-700 mt-1 font-medium">Note: Emails are sent individually. "Dear [Name]" is added automatically.</p>
            </div>
            <div class="flex justify-end gap-3 pt-2 border-t border-amber-200">
                <button type="button" onclick="closeEmailModal()" class="px-6 py-3 text-amber-900 font-bold hover:bg-amber-100 rounded-xl transition">Cancel</button>
                <button type="submit" class="px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white font-bold rounded-xl hover:from-amber-700 hover:to-orange-700 transition shadow-lg flex items-center gap-2">
                    <i class="fa-regular fa-paper-plane"></i> Send Emails
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.applicant-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateButtonState();
    }

    function updateButtonState() {
        const checkboxes = document.querySelectorAll('.applicant-checkbox:checked');
        const btn = document.getElementById('contactBtn');

        if (checkboxes.length > 0) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.classList.add('cursor-pointer');
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.classList.remove('cursor-pointer');
        }
    }

    function openEmailModal() {
        const checkboxes = document.querySelectorAll('.applicant-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value);

        if (ids.length === 0) return;

        document.getElementById('hiddenApplicantIds').value = ids.join(',');
        document.getElementById('recipientCountDisplay').innerText = `${ids.length} Applicant${ids.length > 1 ? 's' : ''} Selected`;

        const modal = document.getElementById('emailModal');
        const content = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeEmailModal() {
        const modal = document.getElementById('emailModal');
        const content = document.getElementById('modalContent');
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
</script>
{% endblock %}